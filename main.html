<!DOCTYPE html>
<html lang="en" style="height:100%;">
	<head>
		<meta charset="utf-8">

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

		<title>Rocket Data</title>
		
		<link type="text/css" rel="stylesheet" href="css/rickshaw.min.css">
		<link type="text/css" rel="stylesheet" href="css/jquery-ui.min.css">
			
		<script src="js/papaparse.min.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/rickshaw.min.js"></script>
		<script src="js/jquery-2.1.1.min.js"></script>
		<script src="js/jquery-ui.min.js"></script>
		
		<style>
			#fileContainer {
				position: fixed;
				height: 60px;
				left: 10px;
				top: 10px;
			}
			#graphContainer {
				position: fixed;
				top: 75px;
				bottom: 130px;
				left: 20px;
				right: 20px;
				margin: 0px;
			}
			#axis0 {
				width: 40px;
				height: 1px;
				float: left;
			}
			#chart{
				left: 60px;
				position: absolute;
			}
			#axis1 {
				width: 40px;
			}
			#annotationContainer {
				position: fixed;
				height: 20px;
				bottom: 110px;
				left: 80px;
				right: 80px;
			}
			#previewContainer {
				position: fixed;
				height: 100px;
				bottom: 10px;
				left: 80px;
				right: 80px;
			}
			#legend {
				position: fixed;
				width: 180px;
				top: 80px;
				right: 20px;
				z-index: 1;
			}
		</style>

	</head>

	<body style="margin: 0px;">

		<div id="fileContainer">
			<span>RADAR data: </span>
			<input type="file" id="radFiles" name="files[]" multiple />
			<span>Payload data: </span>
			<input type="file" id="rocFiles" name="files[]" multiple />
			<br/>
			<output id="list">No file</output>
			<br/>
			<span id="progress">0</span><span> rows processed.</span>
			<br/>
		</div>
		<div id="graphContainer">
			<div id="axis0"></div>
			<div id="chart"></div>
			<div id="axis1"></div>
		</div>
		<div id="annotationContainer">
			<div id="timeline"></div>
		</div>
		<div id="previewContainer">
			<div id="slider"></div>
		</div>
		<div id="legend"></div>

		<script>
			
			// Config
			var DEBUG = true;
			
			///// Globals ////
			// Radar Data
			var RadarData = [];
			// Geiger Counts
			var GeigerData = [];
			// Angular velocity
			var SpinRate = [];
			// All graphable data
			var Series = [];
			
			// Needed to determine if Offset needs to be changed
			var first = true;
			// The first value of Radar, to set position relative to 0
			var offset;
			// Display counter for rows processed
			var rows = 0;
			// For averaging multiple files
			var samples = 0;
			// Handle for the counter
			var counter = document.getElementById('progress');
			// The various scales used by the graphs
			var Scales = [];
			// Placeholders
			var max = 0;
			var min = 0;
			// Debug output
			if(DEBUG){ result = []; }
			
			function radFileSelect(evt) {
				rows = 0;
				if(DEBUG){ result = []; }
				var files = evt.target.files;
				// This block processes the Radar file and creates a graph for it.
				Papa.parse(files[0], {
					dynamicTyping : true,
					delimiter : "",
					step: function(row, handle) {
						if (DEBUG) { result.push(row); }
						// If valid, send to the aggregator
						if (typeof (row.data[0][0]) == 'number') {
							stepRadar(row);
						}
						rows++;
					},
					complete : function(results) {
						first = true;
						polishRADAR();
						// push the data and render the chart
						Series.push({
							name: 'RADAR Altitude',
							data: RadarData,
							scale: Scales[0],
							color: 'rgba(255, 127, 0, 0.4)',
							renderer: 'line'
						});
						counter.innerHTML = rows;
						var yAxis = new Rickshaw.Graph.Axis.Y.Scaled({
							graph: graph,
							orientation: 'left',
							element: document.getElementById("axis0"),
							width: 40,
							height: graph.height,
							scale: Scales[0],
							tickFormat: Rickshaw.Fixtures.Number.formatKMBT
						});
						updateGraph();
					}
				});
				document.getElementById('list').innerHTML = files[0].name;
			}

			function rocFileSelect(evt) {
				var files = evt.target.files;
				time = 0;
				rows = 0;
				if(DEBUG){ result = []; }
				samples++;
				level();
				// This block will process the Payload data
				Papa.parse(files[0], {
					dynamicTyping : true,
					delimiter : "",
					step: function(row, handle) {
						// Clears out empty array elements left by the parser
						row.data[0].forEach(function(obj, index, arr){if(obj == ""){arr.splice(index, 1);}});
						if (DEBUG) { result.push(row); }
						// If valid data, send to the aggregator
						if (typeof (row.data[0][0]) == 'number') {
							stepPayload(row);
						}
						rows++;
					},
					complete : function(results) {
						// Render the chart
						Series.push({
							name: 'Geiger Counts',
							data: GeigerData,
							scale: Scales[1],
							color: 'rgba(255, 0, 0, 0.4)',
							renderer: 'bar',
						});
						graph.render();
						counter.innerHTML = rows;
					}
				});
				document.getElementById('list').innerHTML = files[0].name;
			}
			function stepRadar(a) {
				var time = Math.ceil(a.data[0][0]*10);
				if (first) {
					offset = a.data[0][3];
					first = false;
				}
				if (RadarData[time-1]) {
					RadarData[time-1].y += (a.data[0][3]-offset);
					RadarData[time-1].steps++;
				}
				else {
					RadarData.push({x: time/10, y: (a.data[0][3]-offset), steps: 1});
				}
			}
			
			function stepPayload(a) {
				var time = Math.ceil(a.data[0][0]/1000);
				var halfTime = Math.ceil(a.data[0][0]/500);
				if (GeigerData[time-1]) {
					GeigerData[time-1].y += (a.data[0][13] * (1/samples));
					if (GeigerData[time-1].y > max) {
						max = GeigerData[time-1].y;
					}
				}
				else {
					GeigerData.push({x: time, y: (a.data[0][13] * (1/samples))});
				}
				SpinRate.push({x: a.data[0][0]/1000, y: (a.data[0][12]/5175)});
				if (a.data[0][12]/5175 < min) {
					min = a.data[0][12]/5175;
				}
			}
			
			function level() {
				GeigerData.forEach(function(obj){obj.y *= ((samples-1)/samples)});
			}
			
			function polishRADAR() {
				var max = {x : 0, y : 0};
				RadarData.forEach(function(obj){obj.y *= (0.3048/obj.steps)});
				RadarData.forEach(function(obj){
					if(obj.y > max.y){
						max.y = obj.y;
						max.x = obj.x;
						}
					});
				Scales[0] = d3.scale.linear().domain([0, max.y]).nice();
				annotator.add(max.x, "RADAR Apogee");
				annotator.update();
			}
			
			function initGraph(){
				graph = new Rickshaw.Graph( {
					element: document.getElementById("chart"),
					renderer: 'multi',
					width: document.getElementById("graphContainer").offsetWidth-120,
					height: window.innerHeight-205,
					dotSize: 5,
					series: Series
				});
				
				annotator = new Rickshaw.Graph.Annotate({
					graph: graph,
					element: document.getElementById("timeline")
				});
				
				legend = new Rickshaw.Graph.Legend({
					graph: graph,
					element: document.getElementById("legend")
				});
				
				slider = new Rickshaw.Graph.RangeSlider.Preview({
					graph: graph,
					height: 100,
					element: document.getElementById("slider")
				});
				
				var xAxis = new Rickshaw.Graph.Axis.X({
					graph: graph
				});
			}
			
			function updateGraph(){
				$('#legend').empty();
				$('#slider').empty();
				legend = new Rickshaw.Graph.Legend({
					graph: graph,
					element: document.getElementById("legend")
				});
				slider = new Rickshaw.Graph.RangeSlider.Preview({
					graph: graph,
					height: 100,
					element: document.getElementById("slider")
				});
				graph.render();
			}
			
			var resize = function() {
				graph.configure({
					width: document.getElementById("graphContainer").offsetWidth-120,
					height: window.innerHeight-205,
				});
				graph.render();
			}
	
			document.getElementById('radFiles').addEventListener('change', radFileSelect, false);
			document.getElementById('rocFiles').addEventListener('change', rocFileSelect, false);
			window.addEventListener('resize', resize); 
			initGraph();
			
		</script>


	</body>
</html>

